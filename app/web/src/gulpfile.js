'use strict';

var gulp = require('gulp'),
  jshint = require('gulp-jshint'),
  source = require('vinyl-source-stream'),
  browserify = require('browserify'),
  concat = require('gulp-concat'),
  autoprefixer = require('gulp-autoprefixer'),
  nodemon = require('gulp-nodemon');
var ngAnnotate = require('gulp-ng-annotate');
var uglify = require('gulp-uglify');
var htmlmin = require('gulp-htmlmin');
var gutil = require('gulp-util');
var path = require('path');
var babel = require('gulp-babel');
var cleanCSS = require('gulp-clean-css');

// Dev task
//gulp.task('dev', ['views', 'styles', 'lint', 'browserify', 'watch'], function() {});
gulp.task('default', ['appjs','vendorjs','minify-css','minify-css2','views'], function() {});

gulp.task('appjs', function () {
  return gulp.src(['app/*.module.js','app/*.js','app/**/*.module.js','app/**/*.js'])
    .pipe(concat('app.js', {newLine: ';'}))
    .pipe(ngAnnotate({add: true}))
    .pipe(babel({
      presets: ['es2015']
    }))
    .pipe(uglify({compress:{unsafe:true,hoist_vars:true}}).on('error', gutil.log))
    .pipe(gulp.dest('../static'))
});

gulp.task('vendorjs', function () {
  return gulp.src([
    'node_modules/jquery/dist/jquery.js',
    'node_modules/angular/angular.js',
    'node_modules/angular-jwt/dist/angular-jwt.js',
    'node_modules/showdown/dist/showdown.js',
    'node_modules/ng-flow/dist/ng-flow-standalone.js',
    'node_modules/ng-showdown/dist/ng-showdown.js',
    'node_modules/angular-sanitize/angular-sanitize.js',
    'node_modules/angular-scroll/angular-scroll.js',
    'node_modules/angular-ui-router/release/angular-ui-router.js',
    'libs/angulargrid.js',
    'node_modules/ng-infinite-scroll/build/ng-infinite-scroll.js',
      'libs/ne-music.js',
    'libs/angular-matchheight.js',
    'assets/js/waypoints.min.js',
    'assets/js/bootstrap.min.js',
    'assets/js/retina.min.js',
    'assets/js/jquery.bxslider.min.js',
    'assets/js/nivo-lightbox.min.js'

  ])
    .pipe(concat('vendor.js'))
    .pipe(uglify({compress:{hoist_vars:true}}).on('error', gutil.log))
    .pipe(gulp.dest('../static'))
  /*    .pipe(closureCompiler({
        // compilerPath is optional, since google-closure-compiler is a dependency
        // compilerPath: 'bower_components/closure-compiler/lib/vendor/compiler.jar',
        fileName: '../static/vendor.js',
        compilerFlags: {
          closure_entry_point: 'app.module.js',
          compilation_level: 'ADVANCED_OPTIMIZATIONS',
          define: [
            "goog.DEBUG=false"
          ],

          only_closure_dependencies: true,
          // .call is super important, otherwise Closure Library will not work in strict mode.
          output_wrapper: '(function(){%output%}).call(window);',
          warning_level: 'VERBOSE',
          language_in: "ECMASCRIPT5"

        }
      }))*/
});

gulp.task('minify-css', function() {

  return gulp.src(['assets/css/layouts/default.css','assets/css/responsive.css','assets/css/nivo-lightbox.css'])
    .pipe(concat('app.css'))
    .pipe(cleanCSS({compatibility: 'ie8',processImport:true}))
    .pipe(gulp.dest('../static/styles'));
});

gulp.task('minify-css2', function() {

  return gulp.src(['assets/css/style.css'])
    .pipe(cleanCSS({compatibility: 'ie8',processImport:true}))
    .pipe(gulp.dest('../static/styles'));
});

// JSLint task
gulp.task('lint', function() {
  gulp.src('app/**/*.js')
    .pipe(jshint())
    .pipe(jshint.reporter('default'));
});

// Views task
gulp.task('views', function() {
  // Get our index.html
 // gulp.src('app/index.html')
  // And put it in the public folder
   // .pipe(gulp.dest('../')); //.pipe(htmlmin({collapseWhitespace: true}))

  // Any other view files from app/views
  gulp.src(['app/**/*.html','!app/index.html'])
  // Will be put in the public/views folder
   // .pipe(htmlmin({collapseWhitespace: true}))
    .pipe(gulp.dest('../static'));
});